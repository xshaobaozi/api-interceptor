(()=>{"use strict";const e=window.XMLHttpRequest,t=window.fetch.bind(window),n=()=>{const e={};return["apis","openMock"].forEach((t=>{e[t]=(e=>{try{return JSON.parse(e)}catch(t){return e}})(window.sessionStorage.getItem(`api_interceptor__${t}`))})),e},s=(e,t)=>{if(!e||!t)return;const{apis:s}=n();if(!s)return void console.warn("apis找不到");let o,i=!1;return s.forEach((n=>{if(!0===n.disabled)return;if(!0===i)return;const{schema:s}=n,{paths:r}=s,a=r.find((n=>{const{methods:s,uri:o,disabled:i}=n;return!i&&e.indexOf(o)>-1&&String(t).toLocaleLowerCase()===s}));a&&(i=!0,o=a.response)})),o};class o{constructor(){this._method="";const t=new e;t._open=t.open;const n=this;for(let e in t)"onreadystatechange"!==e?("open"===e&&(t.open=function(...e){0===e.length||(n._method=e[0],t._open(...e))}),"onload"!==e?"function"!=typeof t[e]?["responseText","response"].includes(e)?Object.defineProperty(this,e,{get:()=>null==this[`_${e}`]?t[e]:this[`_${e}`],set:t=>this[`_${e}`]=t,enumerable:!0}):Object.defineProperty(this,e,{get:()=>t[e],set:n=>t[e]=n,enumerable:!0}):this[e]=t[e].bind(t):t.onload=(...e)=>{this.modifilyResponse(),this.onload&&this.onload.apply(this,e)}):t.onreadystatechange=(...e)=>{4==this.readyState&&this.modifilyResponse(),this.onreadystatechange&&this.onreadystatechange.apply(this,e)}}modifilyResponse(){const e=s(this.responseURL,this._method);e&&(this.responseText=e,this.response=e)}}const i=(...e)=>{if(0===e.length)return Promise.reject();let n,o;1===e.length&&(n=e[0]),2===e.length&&(n=e[0],o="object"==typeof e[1]&&e[1].method);const i=s(n,o),r=" object"==typeof i?JSON.stringify(i):i;return t(...e).then((e=>{if(!i)return e;const t=new ReadableStream({start(e){e.enqueue((new TextEncoder).encode(JSON.stringify(r))),e.close()}}),n=new Response(t,{headers:e.headers,status:e.status,statusText:e.statusText}),s=new Proxy(n,{get:function(t,n){switch(n){case"ok":case"redirected":case"type":case"url":case"useFinalURL":case"body":case"bodyUsed":return e[n]}return t[n]}});for(let e in s)"function"==typeof s[e]&&(s[e]=s[e].bind(n));return s}))};i(),new o,window.addEventListener("toPage",(s=>{const{apis:r,openMock:a}=n();(n=>{if(n)return console.log("开启"),window.XMLHttpRequest=o,void(window.fetch=i);console.log("禁用"),window.XMLHttpRequest=e,window.fetch=t})(a)}))})();